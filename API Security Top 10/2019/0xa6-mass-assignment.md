API6:2019 - Mass Assignment - 一括割り当て
===========================

| 脅威エージェント/攻撃経路 | セキュリティ上の弱点 | 影響 |
| - | - | - |
| API 依存 : 攻撃難易度 **2** | 蔓延度 **2** : 検出難易度 **2** | 技術的影響 **2** : ビジネス依存 |
| エクスプロイトを行うには、通常、ビジネスロジック、オブジェクトの関係、API 構造の理解を必要としている。プロパティの名前とともにアプリケーションの基本的な実装を使用上公開しているため、Mass Assignment の悪用は API より簡単である。 | 現代のフレームワークは、開発者に対してクライアントからコード変数や内部オブジェクトに自動的に入力をバインドする関数を使用することを推奨している。攻撃者はこの方法を用いて、決して開発者が公開しようとしていない機微なオブジェクトのプロパティのアップデートや上書きを行うことができる。 | エクスプロイトは、権限昇格、データ改ざん、セキュリティメカニズムのバイパスなどにつながる恐れがある。 |


## API が脆弱かどうかの確認

現代のアプリケーションのオブジェクトは、多くのプロパティを含んでいる可能性がある。これらのプロパティのいくつかは、クライアントによって直接アップデートされるべきであり (たとえば、`user.first_name` や `user.address`)、いくつかはアップデートされるべきではない (たとえば、`user.is_vip` フラグ)。

これらのプロパティの機微性と公開レベルの考慮なしに、クライアントパラメータを内部オブジェクトプロパティに自動変換する場合、API エンドポイントは脆弱である。これによって、アクセスするべきではないオブジェクトプロパティを攻撃者がアップデートできるようになる可能性がある。

Examples for sensitive properties:
機微なプロパティの例：

* **権限関連のプロパティ**: `user.is_admin` や `user.is_vip` は、管理者によってのみ設定されるべきである。
* **プロセス依存のプロパティ**: `user.cash` は、支払い確認後、内部でのみ設定されるべきである。
* **内部プロパティ**: `article.created_time` は、アプリケーションによって内部でのみ設定されるべきである。

## 攻撃シナリオ例

### シナリオ #1

ライドシェアリングアプリケーションは、プロファイルに関する基本情報を編集するオプションをユーザに提供する。このプロセスの間中、API 呼び出しは、以下のような正規の JSON オブジェクトとともに `PUT /api/v1/users/me` に送信される。

```json
{"user_name":"inons","age":24}
```

リクエスト `GET /api/v1/users/me` には、追加の credit_balance プロパティが含まれる。

```json
{"user_name":"inons","age":24,"credit_balance":10}.
```

攻撃者は、以下のペイロードとともに初めのリクエストを再送する。

```json
{"user_name":"attacker","age":60,"credit_balance":99999}
```

エンドポイントは、Mass Assignment に対して脆弱であるため、攻撃者は支払いなしにクレジットを受け取る。


### シナリオ #2

ビデオシェアリングポータルは、ユーザがコンテンツをアップロードできるようにし、様々なフォーマットでコンテンツをダウンロードできるようにする。API を調査した攻撃者は、エンドポイント `GET /api/v1/videos/{video_id}/meta_data` が、ビデオのプロパティを含む JSON オブジェクトを返すことに気付いた。そのプロパティの一つに、`"mp4_conversion_params":"-v codec h264"` があり、それは、アプリケーションがシェルコマンドを使用してビデオを変換していることを意味している。

攻撃者はまた、エンドポイント `POST /api/v1/videos/new` が Mass Assignment に対して脆弱であり、クライアントがビデオオブジェクトの任意のプロパティを設定することができることにも気付いた。この攻撃者は、悪意ある値として `"mp4_conversion_params":"-v codec h264 && format C:/"` を設定する。攻撃者が MP4 としてビデオをダウンロードすると、この値はシェルコマンドインジェクションを引き起こすだろう。

## 対策方法

* 可能であれば、コード変数や内部オブジェクトにクライアントの入力を自動的にバインドするような関数の使用を避ける。
* クライアントによってアップデートされるべきプロパティのみホワイトリストに登録する
* クライアントによってアクセスされるべきではないプロパティをブラックリストに登録するために組み込み機能を使用する。
* 適用できのであれば、入力データペイロードのスキーマを明確に定義して実行する

## References

### External

* [CWE-915: Improperly Controlled Modification of Dynamically-Determined Object Attributes][1]

[1]: https://cwe.mitre.org/data/definitions/915.html
