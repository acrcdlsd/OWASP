API9:2019 Improper Assets Management - 不適切な資産管理
====================================

| 脅威エージェント/攻撃経路 | セキュリティ上の弱点 | 影響 |
| - | - | - |
| API 依存 : 攻撃難易度 **3** | 蔓延度 **3** : 検出難易度 **2** | 技術的影響 **2** : ビジネス依存 |
| 古い API バージョンは、通常、パッチが適用されていないため、最新の API バージョンを保護する最先端のセキュリティメカニズムと戦うことなくシステムを侵害する容易な方法である。 | 古いドキュメントは、脆弱性を検出してフィックスすることをより困難にする。棚卸資産と廃止戦略の欠如は、パッチが適用されていないシステムの実行につながり、機微データが漏えいをもたらす。マイクロサービスのような現代のコンセプトのため、不必要に公開されている API ホストを見つけることは一般的である。これによって、アプリケーションのデプロイや独立が容易となる (たとえば、クラウドコンピューティング、k8s)。 | 攻撃者は機微データへのアクセス権を勝ち取ったり、同じデータベースに接続されている古く、パッチが適用されていない API バージョンを介してサーバを乗っ取る可能性もある。 |

## API が脆弱かどうかの確認

以下の場合、API は脆弱である可能性がある。

* API ホストの目的が明確でなく、以下の問いに対して明確な答えが存在しない場合
  * API がどの環境で実行しているか (たとえば、本番、ステージング、テスト、開発)
  * 誰が API に対してネットワークアクセス権を持っているか (たとえば、パブリック、内部、パートナー)
  * どの API バージョンが実行しているか
  * API によって何のデータが収集され、処理されているか (たとえば、PII)
  * データフローは何か
* ドキュメントが存在しない、もしくは現行のドキュメントがアップデートされていない
* 各 API バージョンの廃止計画が存在しない
* ホストの一覧表が存在しない、もしくは古い
* 1st パーティ、3rd パーティどちらも、統合サービスの一覧表が存在しない、もしくは古い
* 古い、もしくは以前の API バージョンがパッチが適用されずに実行している

## 攻撃シナリオ例

### シナリオ #1

アプリケーションの再設計後、ローカル検索サービスは、実行している古い API バージョン (`api.someservice.com/v1`) を残したままにした。その API は、保護されておらず、またユーザデータベースへのアクセス権を持っている。最新のリリースされたアプリケーションの 1 つをターゲットとしている間に、攻撃者は API アドレス (`api.someservice.com/v2`) を発見した。URL の `v2` を `v1` に置き換えることで、攻撃者は古く保護されていない API へのアクセスを入手し、1 億を超えるユーザの個人識別情報 (PII) を公開した。

### シナリオ #2

攻撃者がブルートフォースを用いてリセットパスワードトークンを推測するのを妨害する帯域制限メカニズムをソーシャルネットワークは実装した。このメカニズムは、API コード自身の一部として実装されていないが、クライアントと公式 API (`www.socialnetwork.com`) 間の単独のコンポーネントに実装されている。研究員は、リセットパスワードメカニズムを含む同じ API を実行しているベータ版の API ホスト (`www.mbasic.beta.socialnetwork.com`) を見つけたが、帯域制限メカニズムが整ってはいなかった。単純なブルートフォースを用いて6 桁トークンを推測することで、研究員は、任意のユーザのパスワードをリセットすることができた。

## 対策方法

* 全ての API ホストの一覧表を作成し、ホスト (たとえば、本番、ステージング、テスト、開発) へのネットワークアクセスを持つべき API 環境 (たとえば、本番、ステージング、テスト、開発) と API バージョンに焦点を当てて、各ホストの重要な側面をドキュメント化する。
* 統合サービスの一覧表を作成し、システムのロール、交換されるデータ (データフロー)、機微性などの重要な側面をドキュメント化する。
* 認証、エラー、転送、帯域制限、クロスオリジンリソース共有 (CORS) ポリシーや、パラメータ、リクエスト、レスポンスを含むエンドポイントなどのAPI の全ての側面をドキュメント化する。
* オープンスタンダードを選択することで自動的にドキュメントを生成する。CI/CD パイプラインに組み込まれたドキュメントを含んでいる。
* API を使用する権限を与えられた人が API ドキュメントを利用できるようにする。
* 現在の製品バージョンだけではなく、API の全ての公開パージョンに関してAPI セキュリティファイアウォールなどの外部の防御手段を使用する。
* 非本番の API デプロイメントで本番データの使用を避ける。もしこのことが避けられないのであれば、エンドポイントは本番環境と同様のセキュリティの処理を確保するべきである。
* API のより新しいべージョンにセキュリティの改良が含まれている場合は、リスク解析を実行し、古いバージョンに必要な緩和アクションの決断を行う。例えば、API の互換性を壊すことなく、その決定を古いバージョンに移植することが可能か、古いバージョンを迅速に排除し、全てのクライアントを最新バージョンに移行する必要があるかなど。

## References

### External

* [CWE-1059: Incomplete Documentation][1]
* [OpenAPI Initiative][2]

[1]: https://cwe.mitre.org/data/definitions/1059.html
[2]: https://www.openapis.org/
