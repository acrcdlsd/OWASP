API5:2019 Broken Function Level Authorization (機能レベルの認可の不備)
=============================================

| 脅威エージェント/攻撃経路 | セキュリティ上の弱点 | 影響 |
| - | - | - |
| API 依存 : 攻撃難易度 **3** | 蔓延度 **2** : 検出難易度 **1** | 技術的影響 **2** : ビジネス依存 |
| エクスプロイトを行うには、攻撃者がアクセスする権限がない API エンドポイントに対して正規の API 呼び出しを送信する必要がある。これらのエンドポイントは、匿名ユーザ、一般の特権権限を持たないユーザに公開される可能性がある。API はより構造化されており、特定の機能にアクセスする方法はより予測しやすい (たとえば、HTTP メソッドを GET から PUT に置き換えたり、URL に含まれる "users" の文字列を "admins" に書き換えるなど) ため、API でこれらの欠陥を検出することは容易である。 | 機能やリソースに関する認可チェックは、通常、設定を介して管理されており、時にはコードレベルで管理されている。現代のアプリケーションは多くのロールやグループ、また複雑なユーザ階層 (たとえば、サブユーザ、1つ以上のロールを持つユーザ) を含んでいるため、適切なチェックを実装することは複雑なタスクである。 | その様な欠陥によって、攻撃者が機能に不正アクセスできるようになる。特権機能は、この種の攻撃にとってキーターゲットである。 |


## API が脆弱かどうかの確認

機能レベルの認可の不備の問題を検出する最も良い方法は、認可メカニズムの深い分析を実行することであり、その上、ユーザの階層、アプリケーション内の様々なロールやグループに留意し、以下の質問をすることである。

* 一般ユーザは、管理エンドポイントにアクセスすることができるか？
* ユーザは、HTTP メソッドを変更する (たとえば、`GET` から `DELETE` に) だけで、アクセスすることができないはずの機微なアクション (たとえば、作成、変更、削除) を実行することができるか？
* グループ X のユーザは、エンドポイントの URL やパラメータを推測するだけ (たとえば、`/api/v1/users/export_all`) で、グループ U のユーザのみに公開されるべき機能にアクセスすることができるか？

API エンドポイントが、URL パスのみに基づいた一般の、もしくは管理上のであること前提としないように。
開発者は、`api/admins` のような固有の相対パスを用いて管理エンドポイントの大半を公開することを選択できるかもしれないが、`api/users` のような一般のエンドポイントとともに、他の相対パスを用いてこれらの管理エンドポイントを見つけることは、誰でも行っていることである。

## 攻撃シナリオ例

### シナリオ #1

招待されたユーザのみが参加できるアプリケーションへの登録プロセスの間中、モバイルアプリケーションは、`GET /api/invites/{invite_guid}` に API コールをトリガーしている。このレスポンスには、ユーザのロールやユーザの E-mail などの招待に関する詳細な JSON が含まれている。

攻撃者はリクエストを複製し、HTTP メソッドとエンドポイントを `POST /api/invites/new` に変更した。このエンドポイントは、管理コンソールを用いている管理者によってのみアクセスされるべきものであり、これは機能レベルの認可チェックを実施していない。
攻撃者は、この問題を悪用し、管理アカウントを作成するための正体を自分自身に送信する：

```
POST /api/invites/new

{“email”:”hugo@malicious.com”,”role”:”admin”}
```

### シナリオ #2

API には、管理者のみにだけ公開されるべきエンドポイント (`GET /api/admin/v1/users/all`) が含まれている。このエンドポイントは、アプリケーションのユーザ全ての詳細を返し、機能レベルの認可チェックを実施しない。API 構造を学んだ攻撃者は、洗練された推測を利用し、アプリケーションのユーザの機微な詳細を公開するエンドポイントに何とかアクセスしようとする。

## 対策方法

アプリケーションは、全てのビジネス機能から呼び出される認可モジュールを解析するために、一貫性と容易性があるべきである。しばしば、その様な保護は、アプリケーションコードの外にある 1 つ以上のコンポ―ネントとによって提供されている。

* 実施メカニズムは、デフォルトで全てのアクセスを拒否するべきであり、全ての機能にアクセスするためには特定のロールに明示的に権利を与える必要がある。
* 機能レベルの認可の欠陥に対して API エンドポイントを見直し、さらに、アプリケーションとグループ階層のビジネスロジックを心に留めておく。
* 管理コントローラの全てが、ユーザのグループ/ロールに基づいた認可チェックを実装する管理抽象コントローラから継承されていることを確認する。
* 一般コントローラ内の管理機能が、ユーザのグループやロールに基づいた認可チェックを実装していることを確認する。

## References

### OWASP

* [OWASP Article on Forced Browsing][1]
* [OWASP Top 10 2013-A7-Missing Function Level Access Control][2]
* [OWASP Development Guide: Chapter on Authorization][3]

### External

* [CWE-285: Improper Authorization][4]

[1]: https://www.owasp.org/index.php/Forced_browsing
[2]: https://www.owasp.org/index.php/Top_10_2013-A7-Missing_Function_Level_Access_Control
[3]: https://www.owasp.org/index.php/Category:Access_Control
[4]: https://cwe.mitre.org/data/definitions/285.html
