API2:2019 Broken User Authentication - 認証の不備
====================================

| 脅威エージェント/攻撃経路 | セキュリティ上の弱点 | 影響 |
| - | - | - |
| API 依存 : 攻撃難易度 **3** | 蔓延度 **2** : 検出難易度 **2** | 技術的影響 **3** : ビジネス依存 |
| API での認証は、複雑かつ理解しづらいメカニズムである。ソフトウェアエンジニアとセキュリティエンジニアは、認証の境界が何かということとそれを適切に実装する方法について誤解している可能性がある。加えて、認証メカニズムは全員に公開されているため、攻撃者にとって容易なターゲットである。これら 2 つのポイントによって、認証コンポーネントは、多くのエクスプロイトに対して潜在的に脆弱となる。 | 2 つの副題がある。1. 保護メカニズムの欠陥：認証に対して責任を負う API エンドポイントは、通常のエンドポイントとは別に処理される必要があり、また追加の保護層を実装する必要がある。2. メカニズムの実装ミス：メカニズムは、攻撃経路を考慮することなしでに使用/実装される。もしくは、ユースケースが間違っている (たとえば、IoT のために設計された認証メカニズムは、Web アプリケーションでは正しい選択ではないかもしれない)。 | 攻撃者は、システム内の他ユーザのアカウントの制御を勝ち取り、個人データを読み取り、金銭取引や個人メッセージの送信などの機微なアクションをユーザに代わって実行することができる。 |

## API が脆弱かどうかの確認

認証エンドポイントと認証フローは、保護する必要がある資産である。"パスワードを忘れた / パスワードリセット" は、認証メカニズムと同じように扱われるべきである。

以下の場合、API は脆弱である。
* [クレデンシャルスタッフィング][1] が可能である。それによって、攻撃者は有効なユーザ名とパスワードのリストを手に入れる。
* CAPTCHAやアカウントロックのメカニズムを提示することなく、攻撃者が同じユーザアカウントに対してブルートフォースアタックを実行することができる。
* 脆弱なパスワードが許可されている。
* 認証トークンやパスワードなどの機微な認証の詳細を URL に含めて送信する。
* トークンの真正性を検証しない。
* 署名されていない/脆弱に署名された JWT トークン (`"alg":"none"`) を受け入れている。有効期限切れを検証しない。
* 平文、暗号化、脆弱にハッシュ化されたパスワードを使用している。
* 脆弱な暗号鍵を使用している。

## 攻撃シナリオ例

## シナリオ #1

[クレデンシャルスタッフィング][1] ([既知のユーザ名/パスワードのリスト][2] の使用) は、一般的な攻撃である。アプリケーションが自動化された脅威やクレデンシャルスタッフィングの保護を実装していない場合、アプリケーションはクレデンシャルが有効かどうかを確認するためのパスワードオラクル (テスター) として使用される可能性がある。

## シナリオ #2

POST リクエストを `/api/system/verification-codes` 宛てに発生させ、リクエストボディにユーザ名を与えることによって、攻撃者はパスワード回復作業を開始する。次に、6 桁の SMS トークンが被害者の電話に送信される。API は帯域制限ポリシーを実装していないため、攻撃者は `/api/system/verification-codes/{smsToken}` エンドポイントに対してマルチスレッドのスクリプトを用いて可能な全ての組み合わせをテストすることで、数分以内に正しいトークンを発見することができる。


## 対策方法

* API (ワンクリック認証などを実装しているモバイル/Web/ディープリンク) への認証を行う可能性がある全てのフローを確認する。
* 見落としたフローについてエンジニアに確認する。
* 認証メカニズムについて読んで知る。何がどのように使用されているかを理解していることを確認する。OAuth は、認証でも API キーでもない。
* 認証、トークン生成、パスワードストレージを一から作り直さない。標準を使用すること。
* クレデンシャルの回復/パスワードエンドポイントの失念は、ブルートフォース、帯域制限、ロックアウト保護の観点からログインエンドポイントとして扱われるべきである。
* [OWASP 認証チートシート][3] を使用する。
* 可能であれば、多要素認証を実装する。
* 認証エンドポイントにおけるクレデンシャルスタッフィング、辞書攻撃、ブルートフォース攻撃を軽減するために、アンチブルートフォースメカニズムを実装する。このメカニズムは、API における通常の帯域制限メカニズムより厳格であるべきである。
* 特定のユーザに対するブルートフォースから保護するために [アカウントロック][4] / CAPTCHA メカニズムを実装する。脆弱なパスワードチェックを実装する。
* API キーは、ユーザ認証ではなく、[クライアントアプリ/プロジェクト認証][5] で使用されるべきである。


## References

### OWASP

* [OWASP Key Management Cheat Sheet][6]
* [OWASP Authentication Cheatsheet][3]
* [Credential Stuffing][1]

### External

* [CWE-798: Use of Hard-coded Credentials][7]

[1]: https://www.owasp.org/index.php/Credential_stuffing
[2]: https://github.com/danielmiessler/SecLists
[3]: https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html
[4]: https://www.owasp.org/index.php/Testing_for_Weak_lock_out_mechanism_(OTG-AUTHN-003)
[5]: https://cloud.google.com/endpoints/docs/openapi/when-why-api-key
[6]: https://www.owasp.org/index.php/Key_Management_Cheat_Sheet
[7]: https://cwe.mitre.org/data/definitions/798.html
