API1:2019 Broken Object Level Authorization - オブジェクトレベルの認可の不備
===========================================

| 脅威エージェント/攻撃経路 | セキュリティ上の弱点 | 影響 |
| - | - | - |
| API 依存 : 攻撃難易度 **3** | 蔓延度 **3** : 検出難易度 **2** | 技術的影響 **3** : ビジネス依存 |
| 攻撃者は、リクエスト内で送信されるオブジェクトの ID を操作することによって、オブジェクトレベルの認可の不備に脆弱な API エンドポイントを悪用することができる。これは、機密データへの不正アクセスにつながる可能性がある。本問題は、API ベースのアプリケーションで極めて一般的である。なぜならば、サーバコンポーネントは、通常、クライアントの状態を完全にはトラッキングすることはなく、その代わりに、どのオブジェクトにアクセスするかを決定するためにクライアントから送信されてくるオブジェクト ID などのパラメータを信頼するからである。 | これは、API に対する攻撃で最も一般的かつ影響のあるものである。現代のアプリケーションにおける認可とアクセス制御のメカニズムは、複雑かつ広範囲に普及している。アプリケーションが認可チェックに関して適切なインフラストラクチャを実装している場合でさえ、開発者は機微なオブジェクトへのアクセスを行う前に、これらのチェックの使用を忘れる可能性がある。アクセス制御の検出は、通常、自動化された静的/動的テストに適していない。 | 不正アクセスは、認可されていない関係者へのデータ公開、データ損失、データ操作につながる。また、オブジェクトへの不正アクセスは、完全なアカウント奪取につながる可能性がある。 |


## API が脆弱かどうかの確認

オブジェクトレベルの認可は、あるユーザがアクセスする必要のあるオブジェクトにのみアクセスできることを検証するために、通常はコードレベルで実装されるアクセス制御メカニズムである。

オブジェクトの ID を受け取り、オブジェクト上であらゆる種類のアクションを実行する全ての API エンドポイントは、オブジェクトレベルの認可チェックを実装するべきである。そのチェックは、ログインしたユーザが要求されたオブジェクトに対して要求されたアクションを実行するための権利を持っているかどうかを検証するべきである。

本メカニズムの不具合は、一般的に、全てのデータの不正な情報開示、改ざん、破壊につながる。


## 攻撃シナリオ例

### シナリオ #1

オンラインストア (ショップ) 向けのeコマースのプラットフォームは、ホストされているショップに関する収益チャートを含むリストページを提供する。ブラウザリクエストを調査することで、攻撃者はこれらのチャートのデータソースとして使用されている API エンドポイントとそれらのパターン `/shops/{shopName}/revenue_data.json` を特定することができる。他の API エンドポイントを用いて、攻撃者はホストされているショップ名全てのリストを手に入れることができる。URL に含まれる `{shopName}` を置き換えるために、リストに含まれる名前を操作するためにシンプルなスクリプトを用いて、攻撃者は、何千もの e コマースストアのセールスデータへのアクセスを勝ち取る。

### シナリオ #2

ウェアラブルデバイスのネットワークトラフィックをモニタリングしている間、次の HTTP `PATCH` リクエストは、カスタム HTTP ヘッダ `X-User-Id: 54796` の存在によって、攻撃者の注意を引く。 `X-User-Id` の値を `54795` に置き換えることによって、攻撃者は HTTP レスポンスの成功を受け取り、他のユーザのアカウントデータを改ざんすることができる。


## 対策方法

* ユーザポリシーとヒエラルキーに依存する適切な認可メカニズムを実装する
* データベースのレコードにアクセスするためにクライアントからの入力を使用する全ての関数のレコードで、要求されたアクションを実行するための権限をログインしたユーザが持っているかどうかをチェックする認可メカニズムを使用する
* レコードの ID の GUID として、ランダムで予測できない値を使用する
* 認可メカニズムを評価するためにテストを作成する。テストを破壊するような脆弱な変更をデプロイしてはならない。


## References

### External

* [CWE-284: Improper Access Control][1]
* [CWE-285: Improper Authorization][2]
* [CWE-639: Authorization Bypass Through User-Controlled Key][3]

[1]: https://cwe.mitre.org/data/definitions/284.html
[2]: https://cwe.mitre.org/data/definitions/285.html
[3]: https://cwe.mitre.org/data/definitions/639.html
