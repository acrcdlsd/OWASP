# M6：安全でない認可制御

<table>
 <tr>
  <th>脅威エージェント</th>
  <th>攻撃経路</th>
  <th colspan="2">セキュリティ上の弱点</th>
  <th>技術的な影響</th>
  <th>ビジネスへの影響</th>
 </tr>
 <tr>
  <td align="center" width="20%">アプリ依存 </td>
  <td align="center" width="15%">攻撃難易度<br>容易</td>
  <td align="center" width="15%">蔓延度<br>中</td>
  <td align="center" width="15%">検出難易度<br>普通</td>
  <td align="center" width="17.5%">影響度<br>重大</td>
  <td align="center" width="17.5%">アプリ / ビジネス依存</td>
 </tr>
 <tr>
  <td>認可制御の脆弱性を悪用する脅威エージェントは、フリーツールやカスタムツールを使用して自動化された攻撃を行います。</td>
  <td>一旦、当該認可スキームの脆弱性を把握することができれば、以降攻撃者は正規ユーザとしてアプリケーションにログインし、認証制御を通過することができます。そして、一度認証を通過すれば、通常攻撃者は管理者権限を実行するために、脆弱なエンドポイントを強制的に閲覧することができます。このような攻撃手法は、通常デバイス内のモバイルマルウェア、もしくは攻撃者が所有するボットネットを介して行われます。</td>
  <td colspan="2">認可スキームの不備をテストするために、テスターはオフラインのモバイルアプリに対してバイナリ攻撃を実行し、特権ユーザにしか実行することができない権限の実行を試みると良いでしょう(バイナリ攻撃の詳細はM9、M10を参照)。またテスターは、重要な機能に対するサーバ通信について、低い権限のセッショントークンをそのPOST/GETリクエストに含めることで、特権機能を実行しようと試みるべきです。認可スキームの不備や欠如は、攻撃者が認証される低い権限のモバイルアプリのユーザを利用して、当該ユーザが権限を持たない機能の実行を許可します。リモートサーバの代わりに、モバイルデバイス内で認可決定を行う場合、認可要件はより脆弱になります。これは、オフラインにおけるユーザビリティのモバイル要件を原因としたものかもしれません。</td>
  <td>認可不備の技術的影響は、認証不備の技術的影響と似た性質を持ちます。技術的影響は、事実上広範囲に及ぶ可能性があり、そして権限を越えて実行される機能の性質に依存します。例えば、リモートやローカルからの権限を越える管理者機能の実行は、システムの破壊や機密情報へのアクセスといった結果につながります。</td>
  <td>ユーザ(匿名もしくは検証済)が権限を越える機能を実行することができる場合、ビジネスは以下の影響を受ける可能性があります。
   <ul>
    <li> 風評被害</li>
    <li> 詐欺</li>
    <li> 情報の窃取</li>
   </ul>
  </td>
 </tr>
</table>


## 脆弱性有無の確認
認証と認可の違いを認識することが重要です。認証は個人を識別する行為であり、認可は識別された個人がその行為を実行するために必要な権限を持っているかをチェックする行為です。認証と認可は密接に関連しており、モバイルデバイスからのリクエストの認証の直後に、認可チェックは常に行われるべきです。

モバイルデバイスからのAPIリクエストを実行する前に、認証及びユーザの識別を失敗した場合、そのコードは自動的に安全でない認可の影響も受けることになります。呼び出し元の身分が判明していない状態で、リクエストに対する認可チェックが発生することは、本来ありえません。

モバイルエンドポイントが安全でない認可の影響を受けるかどうかを判断するには、以下のようないくつかの簡単なルールがあります。

 - **安全でない直接オブジェクト参照(IDOR)の脆弱性の存在 -** 安全でない直接オブジェクト参照(IDOR)があるのなら、コードは妥当な認可チェックを実行していない可能性が最も高いです。
 - **隠されたエンドポイント -** 一般的に開発者は、バックエンドの隠れた機能に対して認可チェックを実行していません。なぜなら、そのような機能は正規のロールを割り当てられた人のみ閲覧できることを想定しているからです。
 - **ユーザのロールや権限の送信 -** モバイルアプリがリクエストの一部としてバックエンドシステムにユーザのロールや権限を送信している場合、安全でない認可の影響を受けます。

## 防止方法
本リスクを回避するために、以下を実施してください。
 - 認証されたユーザのロール及び権限の検証は、バックエンドシステムの情報のみを用いて実施して下さい。モバイルデバイス自体から送信されるロールや権限の情報に頼ることは避けて下さい。
 - バックエンドのコードは、認証情報と共に送信されたリクエストに紐づくあらゆる識別子(要求された操作のオペランド)が、ユーザのアイデンティティに適合しかつそれに由来するものかどうか、独立して検証するべきです。


## 攻撃シナリオの例
**シナリオ #1：** 安全でない直接のオブジェクト参照<br>
  ユーザは、アクターのIDとOAuthのBearer Tokenを含めて、バックエンドREST APIに対するAPIエンドポイントリクエストを作成します。そのリクエストにおいてユーザは、アクターのIDをURLの一部に、アクセストークンを標準ヘッダーに含めます。バックエンドはBearer Tokenの存在は検証しますが、Bearer Tokenに紐づくアクターIDは検証しません。その結果、ユーザはアクターIDに手を加えREST APIリクエストの一部として、他ユーザのアカウント情報を手に入れることができます。

**シナリオ #2：** LDAPロールの送信<br>
  ユーザは、バックエンドREST APIに対して、ユーザが所属するLDAPグループのリストを含むヘッダと、標準のOAuthのBearer Tokenを含むAPIエンドポイントリクエストを作成します。バックエンドリクエストは、機密機能を実行する前にBearer Tokenを検証し、受信するLDAPグループが正当なものかどうかを検査します。しかしながら、バックエンドシステムはLDAPグループメンバーシップの検証を独立して実行せず、代わりにユーザから来るLDAP情報を信頼します。ユーザは、受信するヘッダに手を加え任意のLDAPグループのメンバーであると報告して、管理者機能を実行します。


## 参考資料
### OWASP
 - [こちらを参照](https://www.owasp.org/)

### 外部リンク
 - [CWE-Common Weakness Enumeration](http://cwe.mitre.org/)
