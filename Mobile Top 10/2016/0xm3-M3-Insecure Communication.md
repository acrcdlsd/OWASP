# M3：安全でない通信

<table>
 <tr>
  <th>脅威エージェント</th>
  <th>攻撃経路</th>
  <th colspan="2">セキュリティ上の弱点</th>
  <th>技術的な影響</th>
  <th>ビジネスへの影響</th>
 </tr>
 <tr>
  <td align="center" width="20%">アプリ依存</td>
  <td align="center" width="15%">攻撃難易度<br>容易</td>
  <td align="center" width="15%">蔓延度<br>中</td>
  <td align="center" width="15%">検出難易度<br>普通</td>
  <td align="center" width="17.5%">影響度<br>重大</td>
  <td align="center" width="17.5%">アプリ / ビジネス依存</td>
 </tr>
 <tr>
  <td>モバイルアプリケーションを設計する場合、データは一般的にクライアント/サーバ方式で交換されます。この形式でデータを送信するとき、モバイルデバイスのキャリアネットワークとインターネットを必ず通過します。通信回線を通過する間、脅威エージェントは機密データを傍受するために脆弱性を悪用するかもしれません。例えば以下の脅威エージェントが存在します。
   <ul>
    <li> ローカルネットワーク(不正アクセスされた、もしくは監視されているWi-Fi)を共有する攻撃者</li>
    <li> キャリアもしくはネットワークデバイス(ルータ、基地局、プロキシなど)</li>
    <li> モバイルデバイス上のマルウェア</li>
   </ul>
  </td>
  <td>安全でない通信を悪用する要因は多岐に渡ります。地元のコーヒー店のトラフィックを監視することよりも、キャリアネットワーク上のトラフィックを監視する方が困難です。一般的に標的を定めた攻撃を実行することの方が簡単と言えます。</td>
  <td colspan="2">モバイルアプリケーションは、ネットワークトラフィックを保護していないことが多いです。認証時はSSL/TLSを使用しているかもしれませんが、他では使用していないということがあります。この不整合は、データとセッションIDを傍受に晒してしまうリスクにつながります。トランスポート層セキュリティを使用しているだけでは、アプリケーションが正確に実装されているという意味にはなりません。基本的な欠陥を見つけるには、電話回線のネットワークトラフィックを観察してみてください。より見つけるのが困難な欠陥を見つけるには、アプリケーションの設計とアプリケーションの設定を検査する必要があります。</td>
  <td>この欠陥は個人のユーザデータの漏洩と、アカウントの盗難につながります。もし、攻撃者が管理者アカウントを傍受したのなら、サイト全体が漏洩してしまう可能性があります。また、脆弱なSSL設定はフィッシング攻撃や中間者攻撃を助長してしまう可能性があります。</td>
  <td>少なくとも、通信チャンネルでの機密データの傍受は、プライバシー侵害に当たるでしょう。ユーザの機密性への侵害は次のような結果をもたらすかもしれません。
   <ul>
    <li> なりすまし犯罪</li>
    <li> 詐欺</li>
    <li> 風評被害</li>
   </ul>
  </td>
 </tr>
</table>

## 脆弱性有無の確認
本リスクは、安全になされない2点間のデータ送信全てに該当します。すなわち、モバイル間通信、アプリケーション－サーバ間通信、そしてモバイルからその他への通信を全て含みます。本リスクは、モバイルデバイスが利用するであろう全ての通信技術を含んでいます。例えば、TCP/IP、Wi-Fi、Bluetooth/Bluetooth-LE、NFC、オーディオ、赤外線、GSM、3G、SMS等です。

つまり、TLS通信の全ての問題が本カテゴリに含まれ、また、NFC、BluetoothやWi-Fiの全ての問題が本カテゴリに含まれます。

主な特徴は、機密データをパッケージ化し、デバイスの内部やまたは外部へ送信することです。機密データの例として、暗号鍵、パスワード、個人ユーザ情報、アカウント詳細、セッショントークン、ドキュメント、メタデータ、バイナリデータ等が挙げられます。機密データは、サーバからデバイスに送信されたり、アプリケーションからサーバに送信されたり、あるいはデバイスとローカルの他の何か(例えば、NFC端末やNFCカード)との間に送信されたりします。本リスクで定義される特徴は、2つのデバイスが存在し、それらの間でデータがやり取りされることです。

デバイス自身のローカルにデータが保存される場合、それはM2(Insecure Data Storage：安全でないデータストレージ)に含まれます。セッションの詳細情報が安全に通信されていたとしても(例えば、強力なTLSコネクションなど)、セッション識別子自体に問題がある場合は(予測可能な状態や低エントロピーなど)、通信の問題ではなく、M4(Insecure Authentication：安全でない認証)に含まれます。

本カテゴリで扱う安全でない通信における通常のリスクは、データの完全性、データの機密性、そしてオリジナルの完全性に関してです。(例えば中間者攻撃により)データが伝送中に検出できない形で変更される場合は、本リスクの典型例と言えます。通信の監視(盗聴)、あるいは通信途上のやり取りを記録し後で攻撃することによって(オフライン攻撃)、機密データが公開、獲得、生成される可能性がある場合も、安全でない通信の問題です。TLSコネクションを適切に設定し検証することができていない場合(例えば、証明書検証、脆弱な暗号、他のTLS設定の問題)も、全て本カテゴリで扱う安全でない通信の問題です。


## 防止方法
### 一般的なベストプラクティス
 - ネットワーク層は安全ではなく、盗聴されやすいものと想定すること。
 - バックエンドのAPIやWebサービスに機密情報、セッショントークン、その他の機密データを送信する場合は、モバイルアプリケーションが使用するトランスポート経路にSSL/TLSを適用すること。
 - アプリケーションがブラウザやWebkitでルーチンを実行する場合、サードパーティの解析会社やソーシャルネットワークなどの外部エンティティのSSLバージョンを用いるように考慮すること。混在したSSLセッションは、ユーザのセッションIDが漏洩する可能性があるため、避けること。
 - 適切な鍵長を持つ強固な業界標準の暗号スイートを使用すること。
 - 信頼されたCAプロバイダによって署名された証明書を使用すること。
 - 自己署名証明書は決して許可せず、セキュリティを意識したアプリケーションの場合は、証明書ピニングを検討すること。
 - 常にSSLチェーン検証を要求すること。
 - キーチェーン内の信頼された証明書を使用してエンドポイントサーバのIDを検証できた場合にのみ、セキュアなコネクションを確立すること。
 - モバイルアプリが無効な証明書を検出した場合、UIを通してユーザに警告すること。
 - 機密データを代替となる経路(例えば、SMS、MMS、通知など)で送信しないこと。
 - 可能であれば、SSL通信が行われる前に、機密データに別の暗号化レイヤを適用すること。これにより、将来SSLの実装に脆弱性が発見された場合でも、暗号化されたデータは守秘義務違反への予防策となる。

新たな脅威により、モバイルデバイスのSSLライブラリが通信を暗号化して接続先サーバに送信する直前に、攻撃者は機密通信を傍受して盗聴することが可能となります。このリスクの性質についてはM10を参照してください。
 
### iOS固有のベストプラクティス
最新バージョンのiOSのデフォルトクラスは、SSL暗号強度ネゴシエーションをとても上手く処理します。そのため問題が発生するのは、開発者が、開発上の必要性からデフォルトクラスを回避するコードを一時的に追加してしまった場合です。
上記の一般的なプラクティスに加え、

 - 証明書が有効であり、フェイルクローズされることを確認すること。
 - CFNetworkを使用する時は、信頼されたクライアント証明書を指定するためのSecure Transport APIの使用を検討すること。ほとんどの状況において、より高度な標準的暗号強度としてNSStreamSocketSecurityLevelTLSv1を使用すべきであること。
 - 開発後、全てのNSURLコール(もしくは、NSURLのラッパー)が、NSURLクラスメソッドのsetAllowsAnyHTTPSCertificateなどを使用して、自己署名や無効な証明書を許可することがないように確認すること。
 - 証明書ピニングの利用を検討すること。実施手順としては、まず証明書をエクスポートし、アプリバンドルに含め、信頼オブジェクトにアンカーする。そして、NSURLメソッドのconnection:willSendRequestForAuthenticationChallengeを使用してあなたの証明書を許可することである。
 
### Android固有のベストプラクティス
 - 開発サイクルの後に、org.apache.http.conn.ssl.AllowAllHostnameVerifierやSSLSocketFactory.ALLOW_ALL_HOSTNAME_VERIFIERといったあらゆる証明書を許可するコードは全て削除すること。なぜなら、これはあらゆる証明書を信頼することと同義だからある。
 - SSLSocketFactoryクラスを拡張する場合は、サーバ証明書が正しくチェックされるようにcheckServerTrustedが適切に実装されているかを確認すること。


## 攻撃シナリオの例
モバイルアプリケーションの通信のセキュリティ検査をする時、ペネトレーションテスターが頻繁によく見つけるいくつかのシナリオがあります。
 
### 証明書検証の不備
モバイルアプリケーションとエンドポイントは、安全なチャンネルを確立するために、コネクション後TLSハンドシェイクを実行します。しかしながら、モバイルアプリケーションはサーバによって提供された証明書の検証に不備があると、モバイルアプリケーションはサーバによって提供されたあらゆる証明書を無条件に受け入れます。これは、モバイルアプリケーションとエンドポイント間の相互認証機能を損なうものです。モバイルアプリケーションはTLSプロキシを介した中間者攻撃を受けやすいです。
 
### 脆弱なハンドシェイクネゴシエーション
モバイルアプリケーションとエンドポイントは、コネクション後、コネクションハンドシェイクの一部として暗号スイートのネゴシエートを行います。クライアントーサーバ間において攻撃者によって容易に解読されうる脆弱な暗号スイートを使用するネゴシエーションが行われることがあります。この場合、モバイルアプリケーションとエンドポイント間の通信経路の機密性を危険にさらすことになります。
 
### プライバシー情報の漏えい
モバイルアプリケーションは、SSLの代わりに安全でない通信経路を介してエンドポイントへ個人識別情報を送信することがあります。この場合、モバイルアプリケーションとエンドポイント間のプライバシーデータの機密性を危険にさらすことになります。


## 参考資料
### OWASP
 - [こちらを参照](https://www.owasp.org/)

### 外部リンク
 - [CWE-Common Weakness Enumeration](http://cwe.mitre.org/)

